<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>DNS Monitor</title>
<link rel="stylesheet" href="/dns_frontend.css">

</head>
<body>
<div class="container">
<header>
  <div class="header-kicker">TraceDNS Console</div>
  <h1>DNS Monitor</h1>
  <p>Resolve, decode, verify, and track IOC lifecycle from one operational screen.</p>
  <div class="header-tags">
    <span>TXT/A Decode</span>
    <span>MISP Sync</span>
    <span>Teams Alerting</span>
    <span>History Tracking</span>
  </div>
</header>
<nav>
  <button id="menuSettings">Settings</button>
  <button id="menuDomainVerify">Domain Verify</button>
  <button id="menuStatus" class="active">Status</button>
  <button id="menuQuery">Query</button>
  <button id="menuDomainAnalysis">Domain Analysis</button>
  <button id="menuIpIntel">Botnet IP Analysis</button>
  <button id="menuIPs">All IPs</button>
  <button id="menuValidIPs">Valid IPs</button>
</nav>
<div class="overview-grid" id="overviewGrid">
  <div class="metric-card">
    <span class="metric-label">Configured Domains</span>
    <span class="metric-value" id="metricConfigured">0</span>
  </div>
  <div class="metric-card">
    <span class="metric-label">Status Rows</span>
    <span class="metric-value" id="metricStatusRows">0</span>
  </div>
  <div class="metric-card">
    <span class="metric-label">Managed IOC IPs</span>
    <span class="metric-value" id="metricDecoded">0</span>
  </div>
  <div class="metric-card">
    <span class="metric-label">All / Valid IPs</span>
    <span class="metric-value" id="metricIps">0 / valid 0</span>
  </div>
  <div class="metric-card">
    <span class="metric-label">Last Refresh (Local)</span>
    <span class="metric-value" id="metricUpdated">-</span>
  </div>
</div>

<div id="settings" class="section">
  <h3>âš™ï¸ Settings</h3>
  <div class="tab-buttons">
    <button id="settingsTabDomains" class="active">Domain settings</button>
    <button id="settingsTabCustom">Custom decoders</button>
    <button id="settingsTabAlerts">Alert integrations</button>
  </div>
  <div id="domainSettingsSection">
    <table class="domain-table" id="domainTable">
      <thead><tr><th>Domain</th><th>Type</th><th>TXT Decode</th><th>A Decode</th><th>A XOR Key</th><th></th></tr></thead>
      <tbody></tbody>
    </table>
    <button id="addDomain">+ Add Domain</button>
    
    <label>Servers (comma separated)
      <input id="servers" type="text" placeholder="8.8.8.8, 1.1.1.1" />
    </label>
    <label>Interval (seconds)
      <input id="interval" type="number" min="1" value="60" />
    </label>
    
    <div style="display:flex;gap:10px;flex-wrap:wrap;margin:20px 0;">
      <button id="load">ğŸ“¥ Load</button>
      <button id="save">ğŸ’¾ Save</button>
      <button id="force">âš¡ Force Resolve</button>
      <button id="verifyBtn">ğŸ”¬ Verify</button>
    </div>
    
    <div id="verifyResult" style="background:#f8f9fa;padding:15px;max-height:240px;overflow:auto;margin-top:15px;font-family:monospace;border-radius:8px;border:2px solid #e9ecef;"></div>
  </div>

  <h4 id="customSectionTitle">Custom Decoders</h4>
  <div id="customSection" style="display:none">
    <div class="info-box">
      <strong>ğŸ“š Usage Guide:</strong> New custom decoders are defined as a safe array of steps.
      <ul style="margin:10px 0 0 20px;">
        <li><b>regex</b>: Extract group from text: <code>{"op":"regex","pattern":"(\\d{1,3}(?:\\.\\d{1,3}){3})","group":1}</code></li>
        <li><b>base64</b>/<b>urlsafe_b64</b>: Base64 decode</li>
        <li><b>xor_hex</b>: XOR with key: <code>{"op":"xor_hex","key":"cafebabe"}</code></li>
        <li><b>xor32_ipv4</b> (A Type): IPv4 XOR32: <code>{"op":"xor32_ipv4","key":"E7708E59"}</code></li>
        <li><b>ascii</b>: Convert bytes to ASCII</li>
      </ul>
    </div>

    <label>Name
      <input id="custom_name" type="text" placeholder="decoder_name" />
    </label>
    <label>Decoder Type
      <select id="custom_decoder_type">
        <option value="TXT">TXT</option>
        <option value="A">A</option>
      </select>
    </label>
    <label>Steps (JSON array)
      <textarea id="custom_steps" rows="6" placeholder='[{"op":"regex","pattern":"(\\d{1,3}(?:\\.\\d{1,3}){3})","group":1}]'></textarea>
    </label>
    <label id="custom_sample_label">Sample TXT (for preview)
      <input id="custom_sample" type="text" placeholder='example sample txt' />
    </label>
    <div style="display:flex;gap:10px;margin:15px 0;">
      <button id="previewCustom">ğŸ‘ï¸ Preview</button>
      <button id="registerCustom">âœ”ï¸ Register</button>
      <button id="clearCustom">ğŸ—‘ï¸ Clear</button>
    </div>
    <div id="customPreviewResult" style="background:#fff7e6;padding:15px;margin-top:15px;white-space:pre-wrap;font-family:monospace;border-radius:8px;border:2px solid #ffeaa7;"></div>
    <h5 style="margin-top:15px;color:#1b5970;">Registered Custom Decoders</h5>
    <div id="customList" style="border:2px solid #e9ecef;padding:15px;max-height:220px;overflow:auto;background:#f8f9fa;border-radius:8px;"></div>
  </div>
  <div id="alertsSection" style="display:none">
    <p style="color:#5b6a77;margin-bottom:12px;">Configure Teams/MISP/VirusTotal integration directly from the main console.</p>
    <label for="teams_webhook_front">Teams Webhook URL
      <input id="teams_webhook_front" type="text" placeholder="https://outlook.webhook.office.com/webhookb2/..." />
    </label>
    <label for="misp_url_front">MISP URL
      <input id="misp_url_front" type="text" placeholder="https://misp.example.com" />
    </label>
    <label for="misp_key_front">MISP API Key
      <input id="misp_key_front" type="password" placeholder="Your MISP API key" />
    </label>
    <label for="push_event_id_front">Push Event ID (MISP)
      <input id="push_event_id_front" type="text" placeholder="12345" />
    </label>
    <label style="display:flex;align-items:center;gap:8px;margin-top:8px;font-weight:700;color:#334c5e;">
      <input id="misp_remove_on_absent_front" type="checkbox" style="width:auto;margin:0;" />
      Remove MISP attributes when IP disappears from DNS results
    </label>
    <div class="settings-inline-row">
      <label for="vt_api_key_front">VirusTotal API Key
        <input id="vt_api_key_front" type="password" placeholder="Your VirusTotal API key" />
      </label>
      <label for="vt_cache_ttl_days_front">VT Cache TTL (days)
        <input id="vt_cache_ttl_days_front" type="number" min="1" max="3650" step="1" placeholder="1" />
      </label>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;align-items:center;">
      <button id="loadAlertSettingsBtn">Load Alert Settings</button>
      <button id="saveAlertSettingsBtn">Save Alert Settings</button>
      <span id="alertSettingsStatus" class="settings-status"></span>
    </div>
  </div>
  <pre id="log"></pre>
</div>

<div id="domainverify" class="section">
  <h3>ğŸ§ª Domain Verify &amp; Add</h3>
  <p style="color:#5b6a77;margin-bottom:10px;">Validate DNS behavior first, review type/IP/VT results, then add to monitoring config.</p>
  <div class="domain-verify-grid">
    <label>Domain
      <input id="verifyDomainName" type="text" placeholder="example.com" />
    </label>
    <label>Record Type
      <select id="verifyDomainType">
        <option value="AUTO">Auto detect (A/TXT)</option>
        <option value="A">A</option>
        <option value="TXT">TXT</option>
      </select>
    </label>
    <label>TXT Decode
      <select id="verifyTxtDecode"></select>
    </label>
    <label>A Decode
      <select id="verifyADecode"></select>
    </label>
    <label>A XOR Key
      <input id="verifyAXorKey" type="text" placeholder="E7708E59 or 0xE7708E59" />
    </label>
    <label style="display:flex;align-items:center;gap:8px;margin-top:30px;font-weight:700;color:#334c5e;">
      <input id="verifyIncludeVt" type="checkbox" checked style="width:auto;margin:0;" />
      Include VT score
    </label>
  </div>
  <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:8px 0 10px;">
    <button id="runDomainVerifyBtn">ğŸ”¬ Validate Domain</button>
    <button id="addVerifiedDomainBtn">â• Add Verified Domain</button>
    <button id="clearDomainVerifyBtn">ğŸ§¹ Clear</button>
    <span id="domainVerifyStatus" class="settings-status"></span>
  </div>
  <div id="domainVerifySummary" style="background:#f8f9fa;padding:12px;border:1px solid #d7e4eb;border-radius:10px;margin-bottom:10px;">No validation result yet.</div>
  <h4>DNS Server Results</h4>
  <table id="domainVerifyServerTable">
    <thead><tr><th>DNS Server</th><th>Query Type</th><th>Status</th><th>Values</th><th>Managed IPs</th><th>Method</th></tr></thead>
    <tbody></tbody>
  </table>
  <h4>IP VT Summary</h4>
  <table id="domainVerifyIpTable">
    <thead><tr><th>IP</th><th>Role</th><th>VT (M/S)</th><th>ASN</th><th>AS Owner</th><th>Country</th></tr></thead>
    <tbody></tbody>
  </table>
</div>

<div id="status" class="section">
  <h3>ğŸ“Š Current Status</h3>
  <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:15px;">
    <button id="pauseRefreshBtn">â¸ï¸ Pause Auto-Refresh</button>
    <button id="statusVerifyBtn">ğŸ”¬ Verify Domains</button>
    <span id="refreshState">Auto-refresh active</span>
  </div>
  <div id="statusVerifyResult" style="background:#f8f9fa;padding:15px;max-height:240px;overflow:auto;margin-bottom:15px;font-family:monospace;border-radius:8px;border:2px solid #e9ecef;display:none;"></div>
  <table id="resultsTable">
    <thead><tr><th>Domain</th><th>Type</th><th>Values</th><th>Decoded IPs</th><th>Method</th><th>DNS Servers</th><th>Last Seen</th><th>Actions</th></tr></thead>
    <tbody></tbody>
  </table>
  <h4>Analyzer</h4>
  <div>
    <label>Analysis output:
      <div id="analyzeResult" style="background:#f8f9fa;padding:15px;max-height:200px;overflow:auto;font-family:monospace;border-radius:8px;border:2px solid #e9ecef;"></div>
    </label>
  </div>
  <h4>Domain History</h4>
  <div id="historyBox">Select a domain's "History" button to view events.</div>
</div>

<div id="query" class="section">
  <h3>ğŸ” Query</h3>
  <label>Search value (IP or TXT fragment)
    <input id="queryValue" type="text" placeholder="1.2.3.4 or example-txt" />
  </label>
  <button id="doQuery">ğŸ” Search</button>
  <div id="queryResult"></div>
</div>

<div id="domainanalysis" class="section">
  <h3>ğŸ§­ Domain Analysis</h3>
  <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:8px;">
    <label style="margin:0;font-weight:700;color:#334c5e;display:inline-flex;align-items:center;gap:6px;">
      <input id="domain_analysis_include_vt" type="checkbox" checked style="width:auto;margin:0;" />
      Include AS context (VT)
    </label>
    <button id="refreshDomainAnalysisBtn">ğŸ”„ Refresh</button>
    <span id="domainAnalysisMeta" style="font-size:.78rem;color:#5b6a77;"></span>
    <span class="nxdomain-legend" title="When all DNS servers return NXDOMAIN or fail (with at least one NXDOMAIN), lifecycle starts yellow and turns red over 30 days.">
      <span class="swatch"></span>
      NXDOMAIN lifecycle (30 days)
    </span>
  </div>
  <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:10px;">
    <label style="margin:0;font-weight:700;color:#334c5e;display:inline-flex;align-items:center;gap:6px;">
      Domain Filter
      <select id="domainAnalysisDomainSelect" style="width:auto;min-width:220px;margin-top:0;">
        <option value="">All domains</option>
      </select>
    </label>
    <button id="clearDomainAnalysisFilterBtn">Show All</button>
    <button id="selectNonResolvingDomainsBtn">Select Non-resolving</button>
    <button id="clearSelectedDomainsBtn">Clear Selection</button>
    <button id="removeSelectedDomainsBtn">ğŸ—‘ï¸ Remove Selected</button>
    <span id="domainRemoveStatus" class="settings-status"></span>
  </div>
  <table id="domainDomainStatsTable">
    <thead><tr><th>Domain</th><th>Status</th><th>Resolved IPs</th><th>Decoded IPs</th><th>Unique AS</th><th>Unique Countries</th><th>Top AS</th><th>Top Country</th><th>Last Seen</th><th>Select</th><th>Actions</th></tr></thead>
    <tbody></tbody>
  </table>
  <div class="domain-summary-grid">
    <div class="summary-card">
      <h4>AS Group Summary</h4>
      <table id="domainAsSummaryTable">
        <thead><tr><th>ASN</th><th>AS Owner</th><th>IPs</th><th>Domains</th><th>Countries</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="summary-card">
      <h4>Country Summary</h4>
      <table id="domainCountrySummaryTable">
        <thead><tr><th>Country</th><th>IPs</th><th>Domains</th><th>ASNs</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="summary-card">
      <h4>AS Ã— Country Intersection</h4>
      <table id="domainAsCountrySummaryTable">
        <thead><tr><th>ASN</th><th>Country</th><th>AS Owner</th><th>IPs</th><th>Domains</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
  <table id="domainAnalysisTable">
    <thead><tr><th>Domain</th><th>Status</th><th>Record Types</th><th>Role</th><th>IP</th><th>ASN</th><th>AS Owner</th><th>Country</th><th>VT (M/S)</th><th>Last Seen</th></tr></thead>
    <tbody></tbody>
  </table>
</div>

<div id="ipintel" class="section">
  <h3>ğŸ›°ï¸ Botnet IP Analysis</h3>
  <p style="color:#5b6a77;margin-bottom:10px;">Paste IP list and extract VT-based AS/Country patterns to estimate botnet characteristics.</p>
  <label>Input IP list (newline/comma/space separated)
    <textarea id="ipIntelInput" rows="6" placeholder="1.2.3.4&#10;8.8.8.8, 9.9.9.9"></textarea>
  </label>
  <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:10px;">
    <label style="margin:0;font-weight:700;color:#334c5e;display:inline-flex;align-items:center;gap:6px;">
      <input id="ipIntelIncludeVt" type="checkbox" checked style="width:auto;margin:0;" />
      Include VT enrichment
    </label>
    <label style="margin:0;font-weight:700;color:#334c5e;display:inline-flex;align-items:center;gap:6px;">
      Row limit
      <input id="ipIntelRowLimit" type="number" min="100" max="5000" value="1500" style="width:96px;margin-top:0;" />
    </label>
    <label style="margin:0;font-weight:700;color:#334c5e;display:inline-flex;align-items:center;gap:6px;">
      VT lookup budget
      <input id="ipIntelVtBudget" type="number" min="0" max="5000" value="1200" style="width:96px;margin-top:0;" />
    </label>
    <label style="margin:0;font-weight:700;color:#334c5e;display:inline-flex;align-items:center;gap:6px;">
      VT workers
      <input id="ipIntelVtWorkers" type="number" min="1" max="32" value="8" style="width:84px;margin-top:0;" />
    </label>
    <label style="margin:0;font-weight:700;color:#334c5e;display:inline-flex;align-items:center;gap:6px;">
      MISP Event ID
      <input id="ipIntelMispEventId" type="text" placeholder="push_event_id" style="width:140px;margin-top:0;" />
    </label>
    <button id="loadIpIntelMispBtn">ğŸ“¥ Load from MISP</button>
    <button id="runIpIntelBtn">ğŸ” Analyze IP List</button>
    <span id="ipIntelMeta" style="font-size:.78rem;color:#5b6a77;"></span>
  </div>
  <p style="font-size:.78rem;color:#5b6a77;margin:2px 0 10px;">Supports up to 10,000 valid IPs. Per-IP rows are intentionally limited for browser stability.</p>
  <div class="domain-summary-grid">
    <div class="summary-card">
      <h4>AS Group Summary</h4>
      <table id="ipIntelAsSummaryTable">
        <thead><tr><th>ASN</th><th>AS Owner</th><th>CSP</th><th>IPs</th><th>Malicious</th><th>Countries</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="summary-card">
      <h4>Country Summary</h4>
      <table id="ipIntelCountrySummaryTable">
        <thead><tr><th>Country</th><th>IPs</th><th>ASNs</th><th>Malicious</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="summary-card">
      <h4>AS Ã— Country Intersection</h4>
      <table id="ipIntelAsCountrySummaryTable">
        <thead><tr><th>ASN</th><th>Country</th><th>AS Owner</th><th>CSP</th><th>IPs</th><th>Malicious</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="summary-card">
      <h4>CSP Footprint Summary</h4>
      <table id="ipIntelCspSummaryTable">
        <thead><tr><th>CSP</th><th>IPs</th><th>ASNs</th><th>Countries</th><th>Malicious</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
  <h4>Estimated Characteristics</h4>
  <div id="ipIntelHintsBox" style="background:#f8f9fa;padding:12px;border:1px solid #d7e4eb;border-radius:10px;margin-bottom:10px;"></div>
  <h4>Per-IP Details</h4>
  <table id="ipIntelResultTable">
    <thead><tr><th>IP</th><th>ASN</th><th>AS Owner</th><th>CSP</th><th>Country</th><th>VT (M/S)</th></tr></thead>
    <tbody></tbody>
  </table>
  <h4>Invalid Inputs</h4>
  <div id="ipIntelInvalidBox" style="background:#fff7e6;padding:12px;border:1px solid #f0d39e;border-radius:10px;"></div>
</div>

<div id="ips" class="section">
  <h3>ğŸ“ All IPs</h3>
  <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:8px;">
    <label style="margin:0;font-weight:700;color:#334c5e;display:inline-flex;align-items:center;gap:6px;">
      <input id="ips_include_vt" type="checkbox" checked style="width:auto;margin:0;" />
      Include VT score
    </label>
    <span style="font-size:.78rem;color:#5b6a77;">Uses cached VT results when available.</span>
  </div>
  <table id="ipsTable">
    <thead><tr><th>IP</th><th>Domains</th><th>Count</th><th>Last Seen</th><th>VT Score (M/S)</th><th>VT Context</th></tr></thead>
    <tbody></tbody>
  </table>
</div>

<div id="validips" class="section">
  <h3>âœ… Valid IPs (syntactically valid)</h3>
  <label>Recent seconds:
    <input id="valid_since" type="number" min="0" value="3600" />
    <button id="refreshValidBtn">ğŸ”„ Refresh</button>
  </label>
  <table id="validIpsTable">
    <thead><tr><th>IP</th><th>Domains</th><th>Count</th><th>Last Seen</th><th>Valid</th></tr></thead>
    <tbody></tbody>
  </table>
</div>
</div>

<script src="/dns_frontend.js"></script>

</body>
</html>
