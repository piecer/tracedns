<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>DNS Monitor</title>
<style>
:root{
  --font-ui:"Avenir Next", "Manrope", "Trebuchet MS", "Segoe UI", sans-serif;
  --font-mono:"JetBrains Mono", "Fira Code", "Consolas", "Monaco", monospace;
  --bg-1:#eef5f9;
  --bg-2:#e8f4ef;
  --surface:#ffffff;
  --surface-soft:#f7fbfd;
  --ink:#13212e;
  --muted:#5b6a77;
  --line:#d7e4eb;
  --accent:#0f766e;
  --accent-2:#0ea5a4;
  --accent-warm:#f59e0b;
  --danger:#c43d2b;
  --ok:#1f9a61;
  --radius-lg:20px;
  --radius-md:12px;
  --shadow-xl:0 28px 70px rgba(12, 33, 46, 0.18);
  --shadow-sm:0 8px 18px rgba(19, 33, 46, 0.08);
}
*{margin:0;padding:0;box-sizing:border-box;}
body{
  font-family:var(--font-ui);
  background:
    radial-gradient(1200px 500px at 18% -6%, rgba(14,165,164,0.14), transparent 60%),
    radial-gradient(1000px 420px at 92% 2%, rgba(245,158,11,0.12), transparent 55%),
    linear-gradient(165deg, var(--bg-1) 0%, var(--bg-2) 46%, #f3f9f6 100%);
  min-height:100vh;
  padding:clamp(12px, 2.2vw, 26px);
  color:var(--ink);
}
.container{
  max-width:1360px;
  margin:0 auto;
  background:linear-gradient(180deg, #ffffff 0%, #fbfeff 100%);
  border:1px solid rgba(255,255,255,0.7);
  border-radius:var(--radius-lg);
  box-shadow:var(--shadow-xl);
  overflow:hidden;
}
header{
  position:relative;
  color:#fff;
  padding:36px clamp(18px, 3vw, 34px) 28px;
  background:linear-gradient(118deg, #0f766e 0%, #0ea5a4 48%, #22b08d 100%);
  border-bottom:1px solid rgba(255,255,255,0.2);
}
header::after{
  content:"";
  position:absolute;
  width:320px;
  height:320px;
  border-radius:50%;
  right:-90px;
  top:-190px;
  background:radial-gradient(circle, rgba(255,255,255,0.35) 0%, rgba(255,255,255,0.04) 68%, transparent 72%);
  pointer-events:none;
}
.header-kicker{
  font-size:.78rem;
  letter-spacing:.12em;
  text-transform:uppercase;
  font-weight:700;
  opacity:.88;
  margin-bottom:8px;
}
header h1{
  font-size:clamp(1.9rem, 4.2vw, 2.9rem);
  line-height:1.1;
  font-weight:800;
  margin-bottom:8px;
}
header p{
  font-size:.98rem;
  line-height:1.55;
  max-width:780px;
  opacity:.94;
}
.header-tags{
  margin-top:16px;
  display:flex;
  flex-wrap:wrap;
  gap:8px;
}
.header-tags span{
  background:rgba(255,255,255,0.16);
  border:1px solid rgba(255,255,255,0.34);
  border-radius:999px;
  padding:6px 10px;
  font-size:.76rem;
  font-weight:700;
  letter-spacing:.02em;
}
nav{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  padding:16px clamp(14px, 2vw, 28px);
  background:linear-gradient(180deg, #f9fcfd 0%, #f4f9fc 100%);
  border-bottom:1px solid var(--line);
}
nav button{
  border:1px solid #c5dde6;
  background:#fff;
  color:#16566c;
  border-radius:999px;
  padding:10px 16px;
  font-size:.88rem;
  font-weight:700;
  letter-spacing:.01em;
  cursor:pointer;
  transition:.2s ease;
}
nav button:hover{
  border-color:#1a9ea6;
  color:#fff;
  background:linear-gradient(135deg, #148b88 0%, #0ea5a4 100%);
  transform:translateY(-1px);
}
nav button.active{
  border-color:#0f766e;
  color:#fff;
  background:linear-gradient(135deg, #0f766e 0%, #0ea5a4 100%);
  box-shadow:0 8px 16px rgba(15,118,110,0.24);
}
.overview-grid{
  padding:18px clamp(14px, 2vw, 28px) 2px;
  display:grid;
  grid-template-columns:repeat(auto-fit, minmax(170px, 1fr));
  gap:12px;
  border-bottom:1px solid var(--line);
  background:linear-gradient(180deg, #f8fcfd 0%, #fefefe 100%);
}
.metric-card{
  background:#fff;
  border:1px solid var(--line);
  border-radius:14px;
  padding:12px 14px;
  box-shadow:var(--shadow-sm);
}
.metric-label{
  display:block;
  font-size:.74rem;
  text-transform:uppercase;
  letter-spacing:.08em;
  font-weight:700;
  color:#6c7f8f;
  margin-bottom:7px;
}
.metric-value{
  display:block;
  font-size:1.2rem;
  font-weight:800;
  color:#12374f;
}
.section{
  display:none;
  padding:24px clamp(14px, 2.2vw, 30px) 30px;
  animation:sectionIn .24s ease;
  overflow-x:auto;
}
.section.active{display:block;}
@keyframes sectionIn{from{opacity:0;transform:translateY(8px);}to{opacity:1;transform:translateY(0);}}
.section h3{
  font-size:1.45rem;
  color:#0e5c77;
  margin-bottom:14px;
}
.section h4{
  font-size:1.08rem;
  margin:22px 0 12px;
  color:#1d5f77;
}
label{
  display:block;
  margin:14px 0 7px;
  font-weight:700;
  color:#334c5e;
}
textarea,input[type=text],input[type=number],select{
  width:100%;
  padding:11px 12px;
  margin-top:6px;
  border:1px solid #cddde6;
  border-radius:10px;
  font-size:.92rem;
  font-family:var(--font-ui);
  color:var(--ink);
  background:#fff;
  transition:border-color .18s ease, box-shadow .18s ease;
}
textarea:focus,input[type=text]:focus,input[type=number]:focus,select:focus{
  outline:none;
  border-color:#0ea5a4;
  box-shadow:0 0 0 3px rgba(14,165,164,0.15);
}
button{
  padding:10px 14px;
  margin:8px 8px 8px 0;
  border:1px solid #0f766e;
  border-radius:10px;
  background:linear-gradient(135deg, #0f766e 0%, #0ea5a4 100%);
  color:#fff;
  font-weight:700;
  font-size:.87rem;
  letter-spacing:.01em;
  cursor:pointer;
  transition:.2s ease;
}
button:hover{
  transform:translateY(-1px);
  box-shadow:0 8px 14px rgba(15,118,110,0.24);
}
button:active{transform:translateY(0);}
.tab-buttons{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  margin-bottom:14px;
}
.tab-buttons button{margin:0;}
.tab-buttons button.active{
  border-color:#b96700;
  background:linear-gradient(135deg, #d97706 0%, #f59e0b 100%);
}
#resultsTable{
  width:100%;
  min-width:980px;
}
table{
  width:100%;
  border-collapse:separate;
  border-spacing:0;
  margin-top:14px;
  border:1px solid var(--line);
  border-radius:12px;
  overflow:hidden;
  background:#fff;
  box-shadow:var(--shadow-sm);
}
th{
  position:sticky;
  top:0;
  z-index:1;
  background:linear-gradient(180deg, #1f6780 0%, #1b5970 100%);
  color:#fff;
  padding:11px 10px;
  text-align:left;
  font-weight:700;
  font-size:.82rem;
  letter-spacing:.02em;
  white-space:nowrap;
}
td{
  padding:10px 10px;
  border-bottom:1px solid #ebf2f6;
  max-width:220px;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
  font-size:.88rem;
}
tr:last-child td{border-bottom:none;}
tbody tr:nth-child(2n){background:#fcfeff;}
tbody tr:hover{background:#f0f8fb;}
#resultsTable td:last-child{
  display:flex;
  align-items:center;
  gap:6px;
  flex-wrap:wrap;
  min-width:280px;
  max-width:none;
}
#resultsTable td:last-child button{
  margin:0;
  padding:6px 9px;
  font-size:.75rem;
  border-radius:8px;
  border:1px solid #bed4df;
  background:#fff;
  color:#134560;
  box-shadow:none;
}
#resultsTable td:last-child button:hover{
  border-color:#0ea5a4;
  color:#fff;
  background:linear-gradient(135deg, #0f766e 0%, #0ea5a4 100%);
}
#verifyResult,
#statusVerifyResult,
#analyzeResult,
#customPreviewResult,
#customList,
#historyBox,
#queryResult{
  background:linear-gradient(180deg, #ffffff 0%, #f8fbfd 100%) !important;
  border:1px solid var(--line) !important;
  border-radius:12px !important;
  box-shadow:inset 0 1px 0 rgba(255,255,255,0.85);
}
#historyBox,
#queryResult,
#analyzeResult,
#verifyResult,
#statusVerifyResult,
#customPreviewResult{
  font-family:var(--font-mono) !important;
  font-size:.83rem;
}
#historyBox{height:220px;overflow:auto;padding:14px;}
#queryResult{margin-top:12px;padding:12px;white-space:pre-wrap;word-break:break-word;min-height:96px;}
#log{
  background:#0d1720;
  color:#94ffaa;
  padding:14px;
  height:150px;
  overflow:auto;
  border-radius:12px;
  border:1px solid #223748;
  font-family:var(--font-mono);
  font-size:.8rem;
  line-height:1.45;
  margin-top:14px;
}
.domain-table input{width:100%;}
.domain-table select{width:100%;}
.wrap-cell{
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
  max-width:220px;
  display:block;
}
.info-box{
  background:linear-gradient(132deg, #ebf9f6 0%, #fff9ec 100%);
  border-left:4px solid #0ea5a4;
  padding:14px;
  border-radius:12px;
  margin:12px 0;
  font-size:.9rem;
  line-height:1.56;
}
.info-box code{
  background:#fff;
  padding:1px 6px;
  border-radius:6px;
  font-family:var(--font-mono);
  color:#a33e00;
}
.success{color:var(--ok);font-weight:700;}
.error{color:var(--danger);font-weight:700;}
#refreshState{
  display:inline-flex;
  align-items:center;
  border:1px solid #bfd3dd;
  background:#fff;
  color:#2b4d62;
  border-radius:999px;
  padding:8px 12px;
  font-size:.8rem;
  font-weight:700;
}
#refreshState.is-paused{
  border-color:#f3c07b;
  background:#fff7ea;
  color:#9a5800;
}
@media (max-width:960px){
  nav{gap:8px;}
  nav button{padding:9px 13px;font-size:.82rem;}
  .overview-grid{grid-template-columns:repeat(2, minmax(0, 1fr));}
  .section{padding:18px 12px 24px;}
}
@media (max-width:640px){
  header{padding:26px 14px 20px;}
  .overview-grid{grid-template-columns:1fr;}
  .metric-value{font-size:1.05rem;}
  th,td{font-size:.78rem;}
}
</style>
</head>
<body>
<div class="container">
<header>
  <div class="header-kicker">TraceDNS Console</div>
  <h1>DNS Monitor</h1>
  <p>Resolve, decode, verify, and track IOC lifecycle from one operational screen.</p>
  <div class="header-tags">
    <span>TXT/A Decode</span>
    <span>MISP Sync</span>
    <span>Teams Alerting</span>
    <span>History Tracking</span>
  </div>
</header>
<nav>
  <button id="menuSettings" class="active">Settings</button>
  <button id="menuStatus">Status</button>
  <button id="menuQuery">Query</button>
  <button id="menuIPs">All IPs</button>
  <button id="menuValidIPs">Valid IPs</button>
</nav>
<div class="overview-grid" id="overviewGrid">
  <div class="metric-card">
    <span class="metric-label">Configured Domains</span>
    <span class="metric-value" id="metricConfigured">0</span>
  </div>
  <div class="metric-card">
    <span class="metric-label">Status Rows</span>
    <span class="metric-value" id="metricStatusRows">0</span>
  </div>
  <div class="metric-card">
    <span class="metric-label">Managed IOC IPs</span>
    <span class="metric-value" id="metricDecoded">0</span>
  </div>
  <div class="metric-card">
    <span class="metric-label">All / Valid IPs</span>
    <span class="metric-value" id="metricIps">0 / valid 0</span>
  </div>
  <div class="metric-card">
    <span class="metric-label">Last Refresh (UTC)</span>
    <span class="metric-value" id="metricUpdated">-</span>
  </div>
</div>

<div id="settings" class="section">
  <h3>‚öôÔ∏è Settings</h3>
  <div class="tab-buttons">
    <button id="settingsTabDomains" class="active">Domain settings</button>
    <button id="settingsTabCustom">Custom decoders</button>
  </div>
  <table class="domain-table" id="domainTable">
    <thead><tr><th>Domain</th><th>Type</th><th>TXT Decode</th><th>A Decode</th><th>A XOR Key</th><th></th></tr></thead>
    <tbody></tbody>
  </table>
  <button id="addDomain">+ Add Domain</button>
  
  <label>Servers (comma separated)
    <input id="servers" type="text" placeholder="8.8.8.8, 1.1.1.1" />
  </label>
  <label>Interval (seconds)
    <input id="interval" type="number" min="1" value="60" />
  </label>
  
  <div style="display:flex;gap:10px;flex-wrap:wrap;margin:20px 0;">
    <button id="load">üì• Load</button>
    <button id="save">üíæ Save</button>
    <button id="force">‚ö° Force Resolve</button>
    <button id="verifyBtn">üî¨ Verify</button>
  </div>
  
  <div id="verifyResult" style="background:#f8f9fa;padding:15px;max-height:240px;overflow:auto;margin-top:15px;font-family:monospace;border-radius:8px;border:2px solid #e9ecef;"></div>
  
  <h4>Custom Decoders</h4>
  <div id="customSection" style="display:none">
    <div class="info-box">
      <strong>üìö Usage Guide:</strong> New custom decoders are defined as a safe array of steps.
      <ul style="margin:10px 0 0 20px;">
        <li><b>regex</b>: Extract group from text: <code>{"op":"regex","pattern":"(\\d{1,3}(?:\\.\\d{1,3}){3})","group":1}</code></li>
        <li><b>base64</b>/<b>urlsafe_b64</b>: Base64 decode</li>
        <li><b>xor_hex</b>: XOR with key: <code>{"op":"xor_hex","key":"cafebabe"}</code></li>
        <li><b>ascii</b>: Convert bytes to ASCII</li>
      </ul>
    </div>

    <label>Name
      <input id="custom_name" type="text" placeholder="decoder_name" />
    </label>
    <label>Steps (JSON array)
      <textarea id="custom_steps" rows="6" placeholder='[{"op":"regex","pattern":"(\\d{1,3}(?:\\.\\d{1,3}){3})","group":1}]'></textarea>
    </label>
    <label>Sample TXT (for preview)
      <input id="custom_sample" type="text" placeholder='example sample txt' />
    </label>
    <div style="display:flex;gap:10px;margin:15px 0;">
      <button id="previewCustom">üëÅÔ∏è Preview</button>
      <button id="registerCustom">‚úîÔ∏è Register</button>
      <button id="clearCustom">üóëÔ∏è Clear</button>
    </div>
    <div id="customPreviewResult" style="background:#fff7e6;padding:15px;margin-top:15px;white-space:pre-wrap;font-family:monospace;border-radius:8px;border:2px solid #ffeaa7;"></div>
    <h5 style="margin-top:15px;color:#1b5970;">Registered Custom Decoders</h5>
    <div id="customList" style="border:2px solid #e9ecef;padding:15px;max-height:220px;overflow:auto;background:#f8f9fa;border-radius:8px;"></div>
  </div>
  <pre id="log"></pre>
</div>

<div id="status" class="section">
  <h3>üìä Current Status</h3>
  <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:15px;">
    <button id="pauseRefreshBtn">‚è∏Ô∏è Pause Auto-Refresh</button>
    <button id="statusVerifyBtn">üî¨ Verify Domains</button>
    <span id="refreshState">Auto-refresh active</span>
  </div>
  <div id="statusVerifyResult" style="background:#f8f9fa;padding:15px;max-height:240px;overflow:auto;margin-bottom:15px;font-family:monospace;border-radius:8px;border:2px solid #e9ecef;display:none;"></div>
  <table id="resultsTable">
    <thead><tr><th>Domain</th><th>Type</th><th>Server</th><th>Values</th><th>Decoded IPs</th><th>Method</th><th>Last Seen</th><th>Actions</th></tr></thead>
    <tbody></tbody>
  </table>
  <h4>Analyzer</h4>
  <div>
    <label>Analysis output:
      <div id="analyzeResult" style="background:#f8f9fa;padding:15px;max-height:200px;overflow:auto;font-family:monospace;border-radius:8px;border:2px solid #e9ecef;"></div>
    </label>
  </div>
  <h4>Domain History</h4>
  <div id="historyBox">Select a domain's "History" button to view events.</div>
</div>

<div id="query" class="section">
  <h3>üîé Query</h3>
  <label>Search value (IP or TXT fragment)
    <input id="queryValue" type="text" placeholder="1.2.3.4 or example-txt" />
  </label>
  <button id="doQuery">üîç Search</button>
  <div id="queryResult"></div>
</div>

<div id="ips" class="section">
  <h3>üìç All IPs</h3>
  <table id="ipsTable">
    <thead><tr><th>IP</th><th>Domains</th><th>Count</th><th>Last Seen</th></tr></thead>
    <tbody></tbody>
  </table>
</div>

<div id="validips" class="section">
  <h3>‚úÖ Valid IPs (syntactically valid)</h3>
  <label>Recent seconds:
    <input id="valid_since" type="number" min="0" value="3600" />
    <button id="refreshValidBtn">üîÑ Refresh</button>
  </label>
  <table id="validIpsTable">
    <thead><tr><th>IP</th><th>Domains</th><th>Count</th><th>Last Seen</th><th>Valid</th></tr></thead>
    <tbody></tbody>
  </table>
</div>
</div>

<script>
const SECTION_BUTTON_MAP = {
  settings: 'menuSettings',
  status: 'menuStatus',
  query: 'menuQuery',
  ips: 'menuIPs',
  validips: 'menuValidIPs'
};

function showSection(name){
  ['settings','status','query','ips','validips'].forEach(id=>document.getElementById(id).classList.remove('active'));
  document.getElementById(name).classList.add('active');
  Object.keys(SECTION_BUTTON_MAP).forEach(sec=>{
    const btn = document.getElementById(SECTION_BUTTON_MAP[sec]);
    if(!btn) return;
    btn.classList.toggle('active', sec === name);
  });
}
document.getElementById('menuSettings').onclick = ()=> showSection('settings');
document.getElementById('menuStatus').onclick = ()=> showSection('status');
document.getElementById('menuQuery').onclick = ()=> showSection('query');
document.getElementById('menuIPs').onclick = ()=> showSection('ips');
document.getElementById('menuValidIPs').onclick = ()=> showSection('validips');

function log(msg){ document.getElementById('log').textContent += msg + "\n"; }

const uiOverview = {
  configured: 0,
  statusRows: 0,
  managedIps: 0,
  allIps: 0,
  validIps: 0,
  lastRefreshUtc: '-'
};

function updateOverviewPanel(){
  const set = (id, value)=>{
    const el = document.getElementById(id);
    if(el) el.textContent = value;
  };
  set('metricConfigured', String(uiOverview.configured));
  set('metricStatusRows', String(uiOverview.statusRows));
  set('metricDecoded', String(uiOverview.managedIps));
  set('metricIps', `${uiOverview.allIps} / valid ${uiOverview.validIps}`);
  set('metricUpdated', uiOverview.lastRefreshUtc);
}

function touchOverviewTs(){
  uiOverview.lastRefreshUtc = new Date().toISOString().replace('T', ' ').replace(/\.\d{3}Z$/, 'Z');
  updateOverviewPanel();
}

// Global decoder cache
window.DECODERS = [];
window.A_DECODERS = [];

async function loadDecoders(){
  try{
    const r = await fetch('/decoders');
    if(!r.ok) return;
    const j = await r.json();
    if(j){
      window.DECODERS = Array.isArray(j.decoders) ? j.decoders : [];
      window.CUSTOM_DECODERS = Array.isArray(j.custom) ? j.custom : [];
      window.A_DECODERS = Array.isArray(j.a_decoders) ? j.a_decoders : [];
    }
  }catch(e){ /* ignore */ }
}

function addDomainRow(obj){
  const tbody = document.querySelector('#domainTable tbody');
  const tr = document.createElement('tr');

  const tdName = document.createElement('td');
  const inp = document.createElement('input');
  inp.type = 'text';
  inp.className = 'domain-name';
  inp.value = obj && obj.name ? obj.name : '';
  tdName.appendChild(inp);

  const tdType = document.createElement('td');
  const sel = document.createElement('select');
  sel.className = 'domain-type';
  // Expand supported record type list
  ['A','TXT','AAAA','CNAME','MX','NS','SRV','CAA'].forEach(t=>{ const o = document.createElement('option'); o.value=t; o.text=t; sel.appendChild(o); });
  if(obj && obj.type) sel.value = obj.type.toUpperCase();
  tdType.appendChild(sel);

  // TXT decoder select
  const tdTxtDecode = document.createElement('td');
  const selDecode = document.createElement('select');
  selDecode.className = 'txt-decode';
  // Decoder list is loaded dynamically from the backend; use fallback if not loaded yet
  const FALLBACK_DECODERS = ['cafebabe_xor_base64','plain_base64','btea_variant','xor_ipstring_base64_fixedkey','base64_xor_febabe','base56','safeb64_xor','c2_multiplex'];
  const decs = (window.DECODERS && window.DECODERS.length) ? window.DECODERS : FALLBACK_DECODERS;
  // include custom decoders names as well
  const customNames = (window.CUSTOM_DECODERS || []).map(c=>c.name);
  const finalDecs = (decs || []).concat(customNames.filter(n=>!(decs||[]).includes(n)));
  if(obj && obj.txt_decode && !finalDecs.includes(obj.txt_decode)){
    finalDecs.push(obj.txt_decode);
  }
  finalDecs.forEach(t=>{ const o = document.createElement('option'); o.value=t; o.text=t; selDecode.appendChild(o); });
  if(obj && obj.txt_decode && finalDecs.includes(obj.txt_decode)) selDecode.value = obj.txt_decode;
  tdTxtDecode.appendChild(selDecode);

  // A decoder select
  const tdADecode = document.createElement('td');
  const selADecode = document.createElement('select');
  selADecode.className = 'a-decode';
  const FALLBACK_A_DECODERS = ['none', 'xor32_ipv4'];
  const aDecs = (window.A_DECODERS && window.A_DECODERS.length) ? window.A_DECODERS.slice() : FALLBACK_A_DECODERS.slice();
  if(obj && obj.a_decode && !aDecs.includes(obj.a_decode)){
    aDecs.push(obj.a_decode);
  }
  aDecs.forEach(t=>{ const o = document.createElement('option'); o.value=t; o.text=t; selADecode.appendChild(o); });
  if(obj && obj.a_decode && aDecs.includes(obj.a_decode)) selADecode.value = obj.a_decode;
  tdADecode.appendChild(selADecode);

  // A XOR key input
  const tdAKey = document.createElement('td');
  const inpAKey = document.createElement('input');
  inpAKey.type = 'text';
  inpAKey.className = 'a-xor-key';
  inpAKey.placeholder = 'E7708E59 or 0xE7708E59';
  inpAKey.value = (obj && obj.a_xor_key) ? obj.a_xor_key : '';
  tdAKey.appendChild(inpAKey);

  // Toggle decoder fields by record type
  const toggleDecodeInputs = function(){
    const typ = (sel.value || 'A').toUpperCase();
    const isTXT = typ === 'TXT';
    const isA = typ === 'A';
    selDecode.disabled = !isTXT;
    selADecode.disabled = !isA;
    inpAKey.disabled = !isA;
  };
  sel.onchange = toggleDecodeInputs;
  toggleDecodeInputs();

  const tdBtn = document.createElement('td');
  const del = document.createElement('button'); 
  del.textContent='üóëÔ∏è Remove'; 
  del.title = 'Remove this domain';
  del.onclick = async ()=> { 
    tr.remove();
    uiOverview.configured = document.querySelectorAll('#domainTable tbody tr').length;
    updateOverviewPanel();
    // ÏûêÎèôÏúºÎ°ú Ï†ÄÏû•
    const payload = {
      domains: collectDomainsFromUI(),
      servers: document.getElementById('servers').value.split(',').map(s=>s.trim()).filter(Boolean),
      interval: parseInt(document.getElementById('interval').value) || 60
    };
    try{
      const r = await fetch('/config',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
      const j = await r.json();
      log('Removed domain and saved');
    }catch(e){ 
      log('Remove error:'+e); 
    }
  };
  tdBtn.appendChild(del);
  tr.appendChild(tdName);
  tr.appendChild(tdType);
  tr.appendChild(tdTxtDecode);
  tr.appendChild(tdADecode);
  tr.appendChild(tdAKey);
  tr.appendChild(tdBtn);
  tbody.appendChild(tr);
  uiOverview.configured = document.querySelectorAll('#domainTable tbody tr').length;
  updateOverviewPanel();
}

document.getElementById('addDomain').onclick = ()=> addDomainRow();

// Settings tab switching (domains vs custom decoders)
function showSettingsTab(tab){
  const dom = document.getElementById('domainTable');
  const custom = document.getElementById('customSection');
  const btnDomains = document.getElementById('settingsTabDomains');
  const btnCustom = document.getElementById('settingsTabCustom');
  if(tab === 'custom'){
    dom.style.display = 'none'; custom.style.display = 'block';
    btnDomains.classList.remove('active');
    btnCustom.classList.add('active');
  } else {
    dom.style.display = ''; custom.style.display = 'none';
    btnCustom.classList.remove('active');
    btnDomains.classList.add('active');
  }
}
document.getElementById('settingsTabDomains').onclick = ()=> showSettingsTab('domains');
document.getElementById('settingsTabCustom').onclick = ()=> showSettingsTab('custom');

function collectDomainsFromUI(){
  const rows = document.querySelectorAll('#domainTable tbody tr');
  const out = [];
  rows.forEach(r=>{
    const name = ((r.querySelector('.domain-name') || {}).value || '').trim();
    const typ = ((r.querySelector('.domain-type') || {}).value || 'A').toUpperCase();
    const txt_decode = ((r.querySelector('.txt-decode') || {}).value || '').trim();
    const a_decode = ((r.querySelector('.a-decode') || {}).value || 'none').trim();
    const a_xor_key = ((r.querySelector('.a-xor-key') || {}).value || '').trim();
    if(name) {
      const obj = {name: name, type: typ};
      if(typ === 'TXT'){
        if(txt_decode) obj.txt_decode = txt_decode;
      } else if(typ === 'A'){
        if(a_decode && a_decode !== 'none') obj.a_decode = a_decode;
        // keyÎ•º ÎÑ£ÏóàÎäîÎç∞ methodÎ•º Ïïà Í≥†Î•∏ Í≤ΩÏö∞ xor32 Í∏∞Î≥∏ÏúºÎ°ú ÏûêÎèô ÏßÄÏ†ï
        if(a_xor_key){
          if(!obj.a_decode) obj.a_decode = 'xor32_ipv4';
          obj.a_xor_key = a_xor_key;
        }
      }
      out.push(obj);
    }
  });
  return out;
}

async function loadCfg(){
  try{
    const r = await fetch('/config');
    if(!r.ok){ log('Failed to load config'); return; }
    const j = await r.json();
    if(!j) { log('Invalid config response'); return; }
    document.querySelector('#domainTable tbody').innerHTML = '';
    const domains = j.domains || [];
    if(Array.isArray(domains)) {
      domains.forEach(d=>{
        if(typeof d === 'string') addDomainRow({name:d, type:'A'});
        else if(typeof d === 'object') addDomainRow(d);
      });
      uiOverview.configured = domains.length;
      updateOverviewPanel();
    }
    const servers = j.servers || [];
    document.getElementById('servers').value = (Array.isArray(servers) ? servers : []).join(',');
    document.getElementById('interval').value = j.interval || 60;
    log('Loaded config');
    touchOverviewTs();
  }catch(e){ log('Config load error:'+e); }
}
document.getElementById('load').onclick = loadCfg;

document.getElementById('save').onclick = async ()=>{
  const payload = {
    domains: collectDomainsFromUI(),
    servers: document.getElementById('servers').value.split(',').map(s=>s.trim()).filter(Boolean),
    interval: parseInt(document.getElementById('interval').value) || 60
  };
  uiOverview.configured = payload.domains.length;
  updateOverviewPanel();
  try{
    const r = await fetch('/config',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    const j = await r.json();
    log('Saved: ' + JSON.stringify(j));
  }catch(e){ log('Save error:'+e); }
};

document.getElementById('force').onclick = async ()=>{
  const domains = collectDomainsFromUI();
  try{
    const r = await fetch('/resolve', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({domains: domains})});
    const j = await r.json();
    log('Force requested: '+JSON.stringify(j));
    await refreshResults();
  }catch(e){ log('Force error:'+e); }
};

document.getElementById('verifyBtn').onclick = async ()=>{
  const domains = collectDomainsFromUI();
  const el = document.getElementById('verifyResult');
  el.textContent = 'Running verify...';
  try{
    const r = await fetch('/verify', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({domains: domains})});
    if(!r.ok){ el.textContent = 'Verify request failed: '+r.status; return; }
    const j = await r.json();
    renderVerifyResult(j, 'verifyResult');
  }catch(e){ el.textContent = 'Verify error: '+e; }
};

document.getElementById('statusVerifyBtn').onclick = async ()=>{
  const allDomains = [];
  const table = document.getElementById('resultsTable');
  if(table && table.rows){
    for(let i=1; i<table.rows.length; i++){
      const domain = table.rows[i].cells[0].textContent.trim();
      if(domain && !allDomains.includes(domain)) allDomains.push(domain);
    }
  }
  if(allDomains.length===0){ log('No domains in status table to verify'); return; }
  const el = document.getElementById('statusVerifyResult');
  el.style.display='block';
  el.textContent = 'Running verify for '+allDomains.length+' domains...';
  try{
    const r = await fetch('/verify', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({domains: allDomains})});
    if(!r.ok){ el.textContent = 'Verify request failed: '+r.status; return; }
    const j = await r.json();
    renderVerifyResult(j, 'statusVerifyResult');
  }catch(e){ el.textContent = 'Verify error: '+e; }
};

function renderVerifyResult(j, elementId){
  const el = document.getElementById(elementId);
  el.innerHTML = '';
  if(!j || j.error){ el.textContent = j && j.error ? 'Error: '+j.error : 'No result'; return; }
  const res = j.results || {};
  const doms = Object.keys(res).sort();
  if(doms.length===0){ el.textContent = 'No domains verified'; return; }
  doms.forEach(dom=>{
    const block = document.createElement('div');
    block.style.borderBottom='1px solid #eee'; block.style.padding='6px 0';
    const h = document.createElement('div'); h.textContent = dom; h.style.fontWeight='700';
    block.appendChild(h);
    const data = res[dom];
    if(data.error){ const e = document.createElement('div'); e.textContent = 'Error: '+data.error; block.appendChild(e); el.appendChild(block); return; }
    const analysis = data.analysis || {};
    const keys = Object.keys(analysis).sort((a,b)=> (analysis[b].score||0)-(analysis[a].score||0));
    keys.forEach(k=>{
      const info = analysis[k];
      const row = document.createElement('div');
      row.style.margin='6px 0';
      const title = document.createElement('div'); title.textContent = `${k} ‚Äî score=${info.score} raw=${info.raw_count}`;
      title.style.fontWeight='600';
      row.appendChild(title);
      const ips = info.detailed_ips || [];
      if(ips.length===0){ const none = document.createElement('div'); none.textContent = 'No decoded IPs'; row.appendChild(none); }
      else{
        const tbl = document.createElement('table'); tbl.style.width='100%'; const th = document.createElement('tr'); th.innerHTML='<th>IP</th><th>Valid</th><th>VT(malicious/suspicious)</th><th>VT summary</th>'; tbl.appendChild(th);
        ips.forEach(it=>{
          const tr = document.createElement('tr');
          const tdIp = document.createElement('td'); tdIp.textContent = it.ip||'';
          const tdV = document.createElement('td'); tdV.textContent = it.valid ? 'YES' : 'NO';
          const tdVT = document.createElement('td');
          const tdSum = document.createElement('td');
          if(it.vt){ tdVT.textContent = `${it.vt.malicious||0}/${it.vt.suspicious||0}`; tdSum.textContent = `ASN:${it.vt.asn||''} ${it.vt.country||''}`; }
          else { tdVT.textContent = '-'; tdSum.textContent = '-'; }
          tr.appendChild(tdIp); tr.appendChild(tdV); tr.appendChild(tdVT); tr.appendChild(tdSum); tbl.appendChild(tr);
        });
        row.appendChild(tbl);
      }
      block.appendChild(row);
    });
    el.appendChild(block);
  });
}

async function refreshResults(){
  try{
    const r = await fetch('/results'); 
    if(!r.ok) {
      console.error('refreshResults: HTTP error', r.status);
      return;
    }
    const j = await r.json();
    const tbody = document.querySelector('#resultsTable tbody');
    const results = j.results || {};
    // build a map of existing rows keyed by domain||srv to preserve verify rows and avoid full re-render
    const existing = {};
    Array.from(tbody.querySelectorAll('tr')).forEach(r => {
      if(r.classList && r.classList.contains('verify-row')) return;
      const kd = r.dataset.domain || '';
      const ks = r.dataset.server || '';
      if(kd) existing[kd + '||' + ks] = r;
    });

    const newKeys = [];
    let statusRows = 0;
    const managedSet = new Set();
    Object.keys(results).sort().forEach(d=>{
      const srvMap = results[d];
      if(typeof srvMap !== 'object') return;
      Object.keys(srvMap).forEach(srv=>{
        const info = srvMap[srv];
        if(typeof info !== 'object') return;
        statusRows += 1;
        const rtype = (info.type || '').toUpperCase();
        if(rtype === 'TXT'){
          (info.decoded_ips || []).forEach(ip=>{ if(ip) managedSet.add(ip); });
        } else if(rtype === 'A'){
          (info.values || []).forEach(ip=>{ if(ip) managedSet.add(ip); });
        }
        const key = d + '||' + srv;
        newKeys.push(key);
        let tr = existing[key];
        const fullVals = (info.values||[]).join(' | ');
        const fullDecoded = (info.decoded_ips||[]).join(', ');
        if(tr){
          // update existing row in-place
          tr.dataset.domain = d; tr.dataset.server = srv;
          tr.innerHTML = '';
        } else {
          tr = document.createElement('tr');
          tr.dataset.domain = d; tr.dataset.server = srv;
        }
        const tdDomain = document.createElement('td'); tdDomain.textContent = d;
        const tdType = document.createElement('td'); tdType.textContent = info.type || 'A';
        const tdSrv = document.createElement('td'); tdSrv.textContent = srv;
        const tdVals = document.createElement('td'); tdVals.textContent = fullVals.length > 200 ? fullVals.slice(0,200) + '‚Ä¶' : fullVals; tdVals.title = fullVals; tdVals.className = 'wrap-cell';
        const tdDecoded = document.createElement('td'); tdDecoded.textContent = fullDecoded.length > 200 ? fullDecoded.slice(0,200) + '‚Ä¶' : fullDecoded; tdDecoded.title = fullDecoded; tdDecoded.className = 'wrap-cell';
        const tdMethod = document.createElement('td');
        if(info.type === 'TXT' && info.txt_decode){
          tdMethod.textContent = info.txt_decode;
        } else if(info.type === 'A' && info.a_decode){
          tdMethod.textContent = info.a_xor_key ? `${info.a_decode} (${info.a_xor_key})` : info.a_decode;
        } else {
          tdMethod.textContent = '-';
        }
        const tdTs = document.createElement('td'); tdTs.textContent = info.ts ? new Date(info.ts*1000).toISOString() : '-';
        const tdActions = document.createElement('td');
        
        // History Î≤ÑÌäº (Î™®Îì† Î†àÏΩîÎìú)
        const histBtn = document.createElement('button'); 
        histBtn.className = 'action-btn';
        histBtn.textContent = 'History';
        histBtn.title = 'View history for this domain';
        histBtn.onclick = ()=> loadHistory(d);
        tdActions.appendChild(histBtn);
        
        // TXT Î†àÏΩîÎìúÏù∏ Í≤ΩÏö∞Îßå AnalyzeÏôÄ Verify Î≤ÑÌäº Ï∂îÍ∞Ä
        if(info.type === 'TXT'){
          // Analyze Î≤ÑÌäº
          const analyzeBtn = document.createElement('button'); 
          analyzeBtn.className = 'action-btn';
          analyzeBtn.textContent = 'Analyze';
          analyzeBtn.title = 'Analyze TXT decoding methods';
          analyzeBtn.onclick = async ()=>{
            const sample = (info.values||[]).join('|');
            try{ 
              const r = await fetch('/analyze',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({domain:d,txt:sample})}); 
              const j = await r.json(); 
              renderAnalyzeResult(j);
            }catch(e){ 
              document.getElementById('analyzeResult').textContent = 'Analyze error: '+e; 
            }
          };
          tdActions.appendChild(analyzeBtn);
          
          // Verify Î≤ÑÌäº
          const verifyBtn = document.createElement('button'); 
          verifyBtn.className = 'action-btn';
          verifyBtn.textContent = 'Verify';
          verifyBtn.title = 'Verify this domain\'s TXT records';
          verifyBtn.onclick = async ()=>{
            const next = tr.nextElementSibling;
            if(next && next.classList && next.classList.contains('verify-row') && next.dataset && next.dataset.domain===d){ 
              next.remove(); 
              return; 
            }
            const vtr = document.createElement('tr'); 
            vtr.className = 'verify-row'; 
            vtr.dataset.domain = d;
            const vtd = document.createElement('td'); 
            vtd.colSpan = 9;
            vtd.textContent = 'Verifying '+d+'...'; 
            vtr.appendChild(vtd);
            tr.parentNode.insertBefore(vtr, tr.nextSibling);
            try{ 
              const r = await fetch('/verify',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({domains:[d]})}); 
              const j = await r.json(); 
              vtd.innerHTML=''; 
              if(j && j.results && j.results[d]){ 
                const data = j.results[d]; 
                if(data.error){ 
                  vtd.textContent = 'Error: '+data.error; 
                } else { 
                  const analysis = data.analysis||{}; 
                  const keys = Object.keys(analysis).sort((a,b)=>(analysis[b].score||0)-(analysis[a].score||0)); 
                  keys.forEach(k=>{ 
                    const info = analysis[k]; 
                    const h = document.createElement('div'); 
                    h.style.fontWeight='600'; 
                    h.style.marginTop='10px';
                    h.textContent = `${k} ‚Äî score=${info.score} raw=${info.raw_count}`; 
                    vtd.appendChild(h); 
                    const ips = info.detailed_ips||[]; 
                    if(ips.length===0){ 
                      const none=document.createElement('div'); 
                      none.textContent='No decoded IPs'; 
                      vtd.appendChild(none);
                    } else{ 
                      const tbl=document.createElement('table'); 
                      tbl.style.width='100%'; 
                      tbl.style.marginTop='6px'; 
                      const thr=document.createElement('tr'); 
                      thr.innerHTML='<th>IP</th><th>Valid</th><th>VT(malicious/suspicious)</th><th>Summary</th>'; 
                      tbl.appendChild(thr); 
                      ips.forEach(it=>{ 
                        const trr=document.createElement('tr'); 
                        const tdIp=document.createElement('td'); 
                        tdIp.textContent=it.ip||''; 
                        const tdV=document.createElement('td'); 
                        tdV.textContent=it.valid?'YES':'NO'; 
                        const tdVT=document.createElement('td'); 
                        const tdSum=document.createElement('td'); 
                        if(it.vt){ 
                          tdVT.textContent=`${it.vt.malicious||0}/${it.vt.suspicious||0}`; 
                          tdSum.textContent=`ASN:${it.vt.asn||''} ${it.vt.country||''}`; 
                        } else { 
                          tdVT.textContent='-'; 
                          tdSum.textContent='-'; 
                        } 
                        trr.appendChild(tdIp); 
                        trr.appendChild(tdV); 
                        trr.appendChild(tdVT); 
                        trr.appendChild(tdSum); 
                        tbl.appendChild(trr); 
                      }); 
                      vtd.appendChild(tbl);
                    } 
                  }); 
                } 
              } else { 
                vtd.textContent='No data returned'; 
              } 
            }catch(e){ 
              vtd.textContent='Verify error: '+e; 
            } 
          };
          tdActions.appendChild(verifyBtn);
        }
        
        tr.appendChild(tdDomain); tr.appendChild(tdType); tr.appendChild(tdSrv); tr.appendChild(tdVals); tr.appendChild(tdDecoded); tr.appendChild(tdMethod); tr.appendChild(tdTs); tr.appendChild(tdActions);

        // insert or move row into tbody in desired order
        const existingRow = tbody.querySelector(`tr[data-domain="${d}"][data-server="${srv}"]`);
        if(existingRow){
          // replace in-place
          existingRow.parentNode.replaceChild(tr, existingRow);
        } else {
          tbody.appendChild(tr);
        }
      });
    });
    // remove any stale rows (and their verify rows) not present in newKeys
    Array.from(tbody.querySelectorAll('tr')).forEach(r=>{
      if(r.classList && r.classList.contains('verify-row')) return;
      const key = (r.dataset.domain||'') + '||' + (r.dataset.server||'');
      if(!newKeys.includes(key)){
        // remove associated verify row if any
        const next = r.nextElementSibling;
        if(next && next.classList && next.classList.contains('verify-row') && next.dataset && next.dataset.domain===r.dataset.domain){ next.remove(); }
        r.remove();
      }
    });
    uiOverview.statusRows = statusRows;
    uiOverview.managedIps = managedSet.size;
    touchOverviewTs();
  }catch(e){ console.log('refresh error', e); }
}

async function loadHistory(domain){
  try{
    const r = await fetch('/history?domain='+encodeURIComponent(domain));
    if(!r.ok) { log('history load failed'); return; }
    const j = await r.json();
    const el = document.getElementById('historyBox');
    // j.history is in the format { meta: {...}, events: [...], current: {...} }
    const hist = j.history || {};
    const events = hist.events || [];
    const meta = hist.meta || {};
    
    if(!events || events.length === 0) {
      el.textContent = 'No history for ' + domain + 
        (meta.first_seen ? '\nFirst seen: ' + new Date(meta.first_seen*1000).toISOString() : '') +
        (meta.last_changed ? '\nLast changed: ' + new Date(meta.last_changed*1000).toISOString() : '');
      return;
    }
    
    const lines = ['History for ' + domain];
    if(meta.first_seen) lines.push('First seen: ' + new Date(meta.first_seen*1000).toISOString());
    if(meta.last_changed) lines.push('Last changed: ' + new Date(meta.last_changed*1000).toISOString());
    lines.push('---');
    
    events.forEach(h=>{
      const t = new Date(h.ts*1000).toISOString();
      if(h.new && h.old){
        lines.push(`${t} [${h.server}] (${h.type}) ${ (h.old.values||[]).join(',') } -> ${ (h.new.values||[]).join(',') }`);
      } else if(h.values){
        lines.push(`${t} [${h.server}] (${h.type}) ${ (h.values||[]).join(',') }`);
      } else {
        lines.push(JSON.stringify(h));
      }
    });
    el.textContent = lines.join('\n');
  }catch(e){ log('history error:'+e); }
}

document.getElementById('doQuery').onclick = async ()=>{
  const v = document.getElementById('queryValue').value.trim();
  if(!v){ alert('Enter search value'); return; }
  // try IP first via /ip, then fallback to scanning /results/history via backend? use /ip for IPs only
  const ipPattern = /^(\d{1,3}\.){3}\d{1,3}$/;
  if(ipPattern.test(v)){
    const r = await fetch('/ip?ip='+encodeURIComponent(v));
    const j = await r.json();
    document.getElementById('queryResult').textContent = JSON.stringify(j, null, 2);
  } else {
    // search value across history/current by fetching /results + /history client-side (simple approach)
    const r1 = await fetch('/results'); const res = await r1.json();
    const matches = [];
    for(const d of Object.keys(res.results||{})){
      const srvMap = res.results[d];
      for(const s of Object.keys(srvMap)){
        const info = srvMap[s];
        if((info.values||[]).some(x=>x.includes(v))){
          matches.push({domain:d, server:s, type:info.type, ts:info.ts, values:info.values});
        }
      }
    }
    // also check histories
    const r2 = await fetch('/history?domain=ALL'); // not implemented server-side to return all; instead fetch each domain
    // fallback: fetch history per domain from results list
    const histMatches = [];
    for(const d of Object.keys(res.results||{})){
      const hresp = await fetch('/history?domain='+encodeURIComponent(d));
      const hj = await hresp.json();
      (hj.history||[]).forEach(ev=>{
        if(ev.new && (ev.new.values||[]).some(x=>x.includes(v)) || ev.old && (ev.old.values||[]).some(x=>x.includes(v))){
          histMatches.push({domain:d, server:ev.server, ts:ev.ts, old:ev.old, new:ev.new});
        } else if(ev.values && (ev.values||[]).some(x=>x.includes(v))){
          histMatches.push({domain:d, server:ev.server, ts:ev.ts, values:ev.values});
        }
      });
    }
    document.getElementById('queryResult').textContent = JSON.stringify({current:matches, history:histMatches}, null, 2);
  }
};

async function refreshIPs(){
  try{
    const r = await fetch('/ips');
    if(!r.ok) {
      console.error('refreshIPs: HTTP error', r.status);
      return;
    }
    const j = await r.json();
    const tbody = document.querySelector('#ipsTable tbody');
    tbody.innerHTML = '';
    const arr = j.ips || [];
    if(!Array.isArray(arr)) {
      console.error('refreshIPs: ips is not an array', arr);
      return;
    }
    uiOverview.allIps = arr.length;
    uiOverview.validIps = arr.filter(it=>it && it.valid).length;
    updateOverviewPanel();
    arr.forEach(it=>{
      if(typeof it !== 'object') return;
      const tr = document.createElement('tr');
      const tdIp = document.createElement('td'); tdIp.textContent = it.ip || '';
      const tdDomains = document.createElement('td'); tdDomains.textContent = (it.domains||[]).join(', ');
      const tdCount = document.createElement('td'); tdCount.textContent = it.count || 0;
      const tdTs = document.createElement('td'); tdTs.textContent = it.last_ts ? new Date(it.last_ts*1000).toISOString() : '-';
      tr.appendChild(tdIp); tr.appendChild(tdDomains); tr.appendChild(tdCount); tr.appendChild(tdTs);
      tbody.appendChild(tr);
    });
    touchOverviewTs();
  }catch(e){ console.log('refreshIPs error', e); }
}

function renderAnalyzeResult(j){
  const el = document.getElementById('analyzeResult');
  el.innerHTML = '';
  if(!j || j.error){ el.textContent = j && j.error ? 'Error: '+j.error : 'No result'; return; }
  const analysis = j.analysis || {};
  const keys = Object.keys(analysis);
  if(keys.length === 0){ el.textContent = 'No matching decoders'; return; }
  // find best
  let best = null; let bestScore = -999;
  keys.forEach(k=>{ const s = analysis[k].score || 0; if(s>bestScore){ bestScore=s; best=k; } });

  const title = document.createElement('div'); title.textContent = `Recommendation: ${best} (score=${analysis[best].score})`; title.style.fontWeight='bold'; title.style.marginBottom='6px';
  el.appendChild(title);

  keys.sort((a,b)=> (analysis[b].score||0) - (analysis[a].score||0));
  keys.forEach(k=>{
    const info = analysis[k];
    const box = document.createElement('div');
    box.style.borderBottom='1px solid #eee'; box.style.padding='6px 0';
    if(k===best) box.style.background='#fff7e6';
    const h = document.createElement('div'); h.textContent = `${k} ‚Äî score=${info.score} raw_count=${info.raw_count}`;
    h.style.fontWeight = (k===best)?'700':'400';
    const ips = document.createElement('div'); ips.textContent = 'ips: ' + (info.ips||[]).join(', ');
    ips.style.marginTop='4px';
    box.appendChild(h); box.appendChild(ips);
    el.appendChild(box);
  });
}

async function refreshValidIPs(){
  try{
    const r = await fetch('/ips');
    if(!r.ok){ console.error('refreshValidIPs HTTP', r.status); return; }
    const j = await r.json();
    const tbody = document.querySelector('#validIpsTable tbody');
    tbody.innerHTML = '';
    const arr = j.ips || [];
    if(!Array.isArray(arr)) return;
    // display only syntactically valid IPs (backend also provides 'valid')
    const validOnly = arr.filter(it => it && it.valid);
    uiOverview.allIps = arr.length;
    uiOverview.validIps = validOnly.length;
    updateOverviewPanel();
    validOnly.forEach(it=>{
      const tr = document.createElement('tr');
      const tdIp = document.createElement('td'); tdIp.textContent = it.ip || '';
      const tdDomains = document.createElement('td'); tdDomains.textContent = (it.domains||[]).join(', ');
      const tdCount = document.createElement('td'); tdCount.textContent = it.count || 0;
      const tdTs = document.createElement('td'); tdTs.textContent = it.last_ts ? new Date(it.last_ts*1000).toISOString() : '-';
      const tdValid = document.createElement('td'); tdValid.textContent = it.valid ? 'YES' : 'NO';
      tr.appendChild(tdIp); tr.appendChild(tdDomains); tr.appendChild(tdCount); tr.appendChild(tdTs); tr.appendChild(tdValid);
      tbody.appendChild(tr);
    });
    touchOverviewTs();
  }catch(e){ console.log('refreshValidIPs error', e); }
}

  // Auto-refresh control
  let manualPause = false; // user toggled pause
  let hoverPause = false;  // temporary pause while hovering over results

  function isPaused(){ return manualPause || hoverPause; }
  function updateRefreshStateBadge(){
    const el = document.getElementById('refreshState');
    if(!el) return;
    if(manualPause){
      el.textContent = 'Auto-refresh paused';
      el.classList.add('is-paused');
    } else if(hoverPause){
      el.textContent = 'Inspect mode (hover pause)';
      el.classList.add('is-paused');
    } else {
      el.textContent = 'Auto-refresh active';
      el.classList.remove('is-paused');
    }
  }

  document.getElementById('pauseRefreshBtn').onclick = function(){
    manualPause = !manualPause;
    this.textContent = manualPause ? '‚ñ∂ Resume Auto-Refresh' : '‚è∏ Pause Auto-Refresh';
    updateRefreshStateBadge();
    if(!manualPause){ refreshResults(); refreshIPs(); }
  };

  // pause when user hovers results table to allow inspection of long URLs
  const resultsTable = document.getElementById('resultsTable');
  resultsTable.addEventListener('mouseenter', ()=>{ hoverPause = true; updateRefreshStateBadge(); });
  resultsTable.addEventListener('mouseleave', ()=>{ hoverPause = false; updateRefreshStateBadge(); });

  // periodic refresh ‚Äî skip work if paused to avoid wiping user's view
  setInterval(()=>{ if(!isPaused()) refreshResults(); }, 5000);
  setInterval(()=>{ if(!isPaused()) refreshIPs(); }, 5000);

// initialize dynamic decoders and valid IPs refresh hook
window.addEventListener('load', ()=>{
  updateRefreshStateBadge();
  updateOverviewPanel();
  
  // Initialize sections
  try {
    showSection('settings');
  } catch(e) {
    console.error('Failed to show settings section:', e);
  }
  
  try {
    showSettingsTab('domains');
  } catch(e) {
    console.error('Failed to show settings tab:', e);
  }
  
  loadDecoders().then(()=>{
    // reload config so domain rows pick up decoders if possible
    loadCfg();
  });
  
  try {
    refreshResults();
    refreshIPs();
  } catch(e) {
    console.error('Failed to refresh:', e);
  }
  
  document.getElementById('refreshValidBtn').onclick = ()=>{
    const s = parseInt(document.getElementById('valid_since').value) || 0;
    refreshValidIPs(s);
  };
  // initial load of valid ips
  refreshValidIPs(parseInt(document.getElementById('valid_since').value) || 0);
  // custom decoder UI handlers
  function renderCustomList(){
    const el = document.getElementById('customList'); el.innerHTML='';
    const arr = window.CUSTOM_DECODERS || [];
    if(!arr.length){ el.textContent = 'No custom decoders registered'; return; }
    arr.forEach(c=>{
      const row = document.createElement('div'); row.style.borderBottom='1px solid #eee'; row.style.padding='6px 0';
      const title = document.createElement('div'); title.textContent = c.name; title.style.fontWeight='700'; row.appendChild(title);
      const btnRow = document.createElement('div'); btnRow.style.marginTop='6px';
      const edit = document.createElement('button'); edit.textContent='Edit'; edit.onclick = ()=>{
        document.getElementById('custom_name').value = c.name; document.getElementById('custom_name').disabled = true;
        document.getElementById('custom_steps').value = JSON.stringify(c.steps, null, 2);
        document.getElementById('customPreviewResult').textContent = 'Editing '+c.name+' ‚Äî change steps and click Update';
      };
      const del = document.createElement('button'); del.textContent='Delete'; del.onclick = async ()=>{
        if(!confirm('Delete decoder '+c.name+' ?')) return;
        try{
          const r = await fetch('/decoders/custom',{method:'DELETE',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:c.name})});
          const j = await r.json();
          if(j && j.status === 'ok'){ document.getElementById('customPreviewResult').textContent = 'Deleted '+c.name; await loadDecoders(); renderCustomList(); loadCfg(); }
          else { document.getElementById('customPreviewResult').textContent = 'Delete failed: '+JSON.stringify(j); }
        }catch(e){ document.getElementById('customPreviewResult').textContent = 'Delete error: '+e; }
      };
      const upd = document.createElement('button'); upd.textContent='Update'; upd.onclick = async ()=>{
        const stepsRaw = document.getElementById('custom_steps').value.trim(); let steps;
        try{ steps = JSON.parse(stepsRaw); }catch(e){ alert('Invalid JSON: '+e); return; }
        try{
          const r = await fetch('/decoders/custom',{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:c.name,steps:steps})});
          const j = await r.json();
          if(j && j.status === 'ok'){ document.getElementById('customPreviewResult').textContent = 'Updated '+c.name; await loadDecoders(); renderCustomList(); loadCfg(); document.getElementById('custom_name').disabled = false; }
          else { document.getElementById('customPreviewResult').textContent = 'Update failed: '+JSON.stringify(j); }
        }catch(e){ document.getElementById('customPreviewResult').textContent = 'Update error: '+e; }
      };
      btnRow.appendChild(edit); btnRow.appendChild(upd); btnRow.appendChild(del); row.appendChild(btnRow);
      el.appendChild(row);
    });
  }

  document.getElementById('previewCustom').onclick = async ()=>{
    const stepsRaw = document.getElementById('custom_steps').value.trim();
    const sample = document.getElementById('custom_sample').value;
    let steps;
    try{ steps = JSON.parse(stepsRaw); }catch(e){ document.getElementById('customPreviewResult').textContent = 'Invalid JSON: '+e; return; }
    try{
      const r = await fetch('/decoders/custom/preview',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({steps: steps, sample: sample})});
      const j = await r.json();
      document.getElementById('customPreviewResult').textContent = JSON.stringify(j, null, 2);
    }catch(e){ document.getElementById('customPreviewResult').textContent = 'Preview error: '+e; }
  };

  document.getElementById('registerCustom').onclick = async ()=>{
    const name = document.getElementById('custom_name').value.trim();
    const stepsRaw = document.getElementById('custom_steps').value.trim();
    if(!name){ alert('Provide a name'); return; }
    let steps;
    try{ steps = JSON.parse(stepsRaw); }catch(e){ alert('Invalid JSON steps: '+e); return; }
    try{
      const r = await fetch('/decoders/custom',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name: name, steps: steps})});
      const j = await r.json();
      if(j && j.status === 'ok'){
        document.getElementById('customPreviewResult').textContent = 'Registered: '+name;
        // reload decoders and UI
        await loadDecoders();
        renderCustomList();
        loadCfg();
      } else {
        document.getElementById('customPreviewResult').textContent = 'Register failed: '+JSON.stringify(j);
      }
    }catch(e){ document.getElementById('customPreviewResult').textContent = 'Register error: '+e; }
  };
  document.getElementById('clearCustom').onclick = ()=>{
    document.getElementById('custom_name').value='';
    document.getElementById('custom_steps').value='';
    document.getElementById('custom_sample').value='';
    document.getElementById('custom_name').disabled = false;
    document.getElementById('customPreviewResult').textContent='';
  };
  // render custom list initially
  renderCustomList();
});
</script>
</body>
</html>
